
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user has a specific role
    function isRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userRole == role;
    }

    // Helper function to check if a user is updating their own profile correctly
    function userCanUpdateProfile(userId) {
      // 1. The user must be the owner of the document.
      let isOwner = request.auth.uid == userId;

      // 2. Define the list of fields that a user CANNOT change themselves.
      let protectedFields = ['userRole', 'planTier', 'plan', 'hasAccess', 'paidAt', 'email', 'referralCode', 'isDisabled', 'referredBy'];

      // 3. Get the list of fields the user is trying to modify.
      let changedKeys = request.resource.data.diff(resource.data).affectedKeys();

      // 4. The update is allowed IF the user is the owner AND they are not trying to change any of the protected fields.
      return isOwner && changedKeys.disjoint(protectedFields);
    }

    // == USERS ==
    // Any authenticated user can read user profiles (for referral program).
    // Users can create their own profile.
    // Users can update their own profile as long as they don't change protected fields.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == userId;
      allow update: if userCanUpdateProfile(userId);
      
      // Admins can read and write any user profile, overriding the user update rule.
      allow write: if isRole('ADMIN');
    }

    // == STORES ==
    // Any authenticated user can read a store's details (for public storefronts).
    // Only the store owner can create or update their store's details.
    match /stores/{storeId} {
      allow read;
      allow write: if request.auth.uid == storeId;

      // == STORE PRODUCTS ==
      // Any authenticated user can read products within a store.
      // Only the store owner can add, update, or delete products in their own store.
      match /products/{productId} {
        allow read;
        allow write: if request.auth.uid == storeId;
      }
      
      // == STORE ORDERS ==
      // Only the store owner can read their own orders.
      // Creating orders is handled server-side by the webhook. No client creation allowed.
      match /orders/{orderId} {
        allow read: if request.auth.uid == storeId;
        allow create: if false; // Block client-side order creation
      }
    }
    
    // == PENDING MASTER CATALOG ==
    // Only verified SELLERS can add new products for approval.
    // Admins can read all pending products.
    match /Pending_Master_Catalog/{productId} {
        allow read: if isRole('ADMIN');
        allow create: if isRole('SELLER');
        allow update: if isRole('ADMIN'); // Admins can approve/reject
    }
    
    // == MASTER CATALOG ==
    // All authenticated users can read the master catalog to view dropshippable products.
    // Only Admins can write to the master catalog.
    match /Master_Catalog/{productId} {
        allow read: if request.auth != null;
        allow write: if isRole('ADMIN');
    }
    
    // == TRAINING MODULES ==
    // All authenticated users can read training modules.
    // Only Admins can create or update them.
     match /Training_Modules/{moduleId} {
        allow read: if request.auth != null;
        allow write: if isRole('ADMIN');
    }

    // == PAYOUTS & REVENUE ==
    // Payout and revenue records are write-only from the server-side webhook.
    // Reading is restricted.
    match /payouts_pending/{payoutId} {
      allow read: if request.auth.uid == resource.data.userId || isRole('ADMIN');
      allow create: if false; // Server-side only
      allow update: if isRole('ADMIN'); // Only admins can change status
    }
    
     match /payouts_completed/{payoutId} {
      allow read: if request.auth.uid == resource.data.userId || isRole('ADMIN');
      allow create: if false; // Server-side only
    }
    
    match /revenue_logs/{revenueId} {
        allow read: if isRole('ADMIN');
        allow create: if false; // Server-side only
    }
    
    // == WITHDRAWAL REQUESTS ==
    // Users can create their own withdrawal requests.
    // Users can read their own requests.
    // Admins can read all requests and update their status.
    match /withdrawal_requests/{reqId} {
        allow create: if request.auth.uid == request.resource.data.userId;
        allow read: if request.auth.uid == resource.data.userId || isRole('ADMIN');
        allow update: if isRole('ADMIN');
    }
    
    // == ADMIN ALERTS ==
    // Write-only from the server-side. Read-only for admins.
    match /admin_alerts/{alertId} {
        allow read: if isRole('ADMIN');
        allow write: if false; // Server-side only
    }
  }
}
