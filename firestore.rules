rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user has a specific role
    function isRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userRole == role;
    }

    // Helper function to check if the user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // == USERS ==
    // Any authenticated user can read user profiles (for referral program).
    // Users can update their own profile, but cannot change their role, plan, access status, or referral info once set.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow update: if request.auth.uid == userId
        && !(request.resource.data.userRole is string && request.resource.data.userRole != resource.data.userRole)
        && !(request.resource.data.planTier is string && request.resource.data.planTier != resource.data.planTier)
        && !(request.resource.data.isAdmin is bool && request.resource.data.isAdmin != resource.data.isAdmin)
        && (resource.data.referredBy == null || request.resource.data.referredBy == resource.data.referredBy);
      
      // Admins can read and write any user profile.
      allow write: if isAdmin();
    }

    // == STORES ==
    // Any authenticated user can read a store's details (for public storefronts).
    // Only the store owner can create or update their store's details.
    match /stores/{storeId} {
      allow read;
      allow write: if request.auth.uid == storeId;

      // == STORE PRODUCTS ==
      // Any authenticated user can read products within a store.
      // Only the store owner can add, update, or delete products in their own store.
      match /products/{productId} {
        allow read;
        allow write: if request.auth.uid == storeId;
      }
      
      // == STORE ORDERS ==
      // Only the store owner can read their own orders.
      // Creating orders is handled server-side by the webhook. No client creation allowed.
      match /orders/{orderId} {
        allow read: if request.auth.uid == storeId;
        allow create: if false; // Block client-side order creation
      }
    }
    
    // == PENDING MASTER CATALOG ==
    // Only verified SELLERS can add new products for approval.
    // Admins can read all pending products.
    match /Pending_Master_Catalog/{productId} {
        allow read: if isAdmin();
        allow create: if isRole('SELLER');
        allow update: if isAdmin(); // Admins can approve/reject
    }
    
    // == MASTER CATALOG ==
    // All authenticated users can read the master catalog to view dropshippable products.
    // Only Admins can write to the master catalog.
    match /Master_Catalog/{productId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    
    // == TRAINING MODULES ==
    // All authenticated users can read training modules.
    // Only Admins can create or update them.
     match /Training_Modules/{moduleId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }

    // == PAYOUTS & REVENUE ==
    // Payout and revenue records are write-only from the server-side webhook.
    // Reading is restricted.
    match /payouts_pending/{payoutId} {
      allow read: if request.auth.uid == resource.data.userId || isAdmin();
      allow create: if false; // Server-side only
      allow update: if isAdmin(); // Only admins can change status
    }
    
     match /payouts_completed/{payoutId} {
      allow read: if request.auth.uid == resource.data.userId || isAdmin();
      allow create: if false; // Server-side only
    }
    
    match /revenue_logs/{revenueId} {
        allow read: if isAdmin();
        allow create: if false; // Server-side only
    }
    
    // == WITHDRAWAL REQUESTS ==
    // Users can create their own withdrawal requests.
    // Users can read their own requests.
    // Admins can read all requests and update their status.
    match /withdrawal_requests/{reqId} {
        allow create: if request.auth.uid == request.resource.data.userId;
        allow read: if request.auth.uid == resource.data.userId || isAdmin();
        allow update: if isAdmin();
    }
    
    // == ADMIN ALERTS ==
    // Write-only from the server-side. Read-only for admins.
    match /admin_alerts/{alertId} {
        allow read: if isAdmin();
        allow write: if false; // Server-side only
    }
  }
}
